pipeline {
  agent {
    docker {
      image 'python:3.11-slim'
    }
  }

  options {
    timestamps()
    ansiColor('xterm')
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Instalar dependencias') {
      steps {
        sh '''
          apt-get update -qq
          apt-get install -y curl
          python -m venv .venv
          . .venv/bin/activate
          pip install requests
        '''
      }
    }

    stage('Comprobar APIs') {
      steps {
        sh '''
          set -e
          . .venv/bin/activate

          echo "=== Comprobando APIs desde api_endpoints.txt ==="
          python - <<'PY'
import requests, sys, time

filename = "api_endpoints.txt"
try:
    with open(filename, "r") as f:
        urls = [line.strip() for line in f if line.strip()]
except FileNotFoundError:
    print(f"ERROR: No se encuentra el archivo {filename}")
    sys.exit(1)

if not urls:
    print("No hay URLs en el archivo.")
    sys.exit(1)

for url in urls:
    print(f"\nðŸ”Ž Probando {url} ...")
    try:
        start = time.time()
        resp = requests.get(url, timeout=10)
        elapsed = round((time.time() - start) * 1000)
        if resp.status_code == 200:
            print(f"âœ… {url} OK (HTTP 200) â€” {elapsed} ms")
        else:
            print(f"âŒ {url} devolviÃ³ {resp.status_code}")
            sys.exit(1)
    except requests.exceptions.RequestException as e:
        print(f"âŒ Error al conectar con {url}: {e}")
        sys.exit(1)

print("\nTodas las APIs respondieron correctamente âœ…")
PY
        '''
      }
    }
  }

  post {
    success {
      echo 'âœ… Todas las APIs estÃ¡n funcionando correctamente.'
    }
    failure {
      echo 'âŒ Alguna API no respondiÃ³ correctamente.'
    }
  }
}
